---
title: "Project introduction: Soil carbon modelling in Morrocan agriculture"
author: "Dr Alasdair Sykes"
date: "25-04-2020"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<br>
<br>
<br>
```{r, out.width = "60%", fig.align = "center", echo = F}
knitr::include_graphics("not-for-students/hatim-belyamani-1GZWbLJWfRo-unsplash.jpg")
```
<br>
```{r main_plot, echo = F, message = F, fig.align = 'center', fig.height = 3, fig.width = 7}
source("ipcc-c-model-functions.R")
Dat_bl <- read_rds("model-scenarios/scenario-baseline.rds")

Dat_mod <- Dat_bl %>%
  mutate(scenario_baseline = scenario_baseline %>%
           map(function(df){
             df %>% mutate(till_type = c(rep("full", 58), rep("zero", 79)))
           }) %>%
           map(run_model))
ts_plot(Dat_bl, Dat_mod) +
  theme(legend.position = "none")

```
<br>
<br>

## 1. Introduction

#### 1.1. Goal of project
The overall goal of this project is to estimate the soil carbon stocks, and the potential for soil carbon stock change, in Moroccoâ€™s agricultural production systems. To do this, you will use an internationally parameterised steady state soil carbon model to make quantitative predictions of soil carbon stocks and stock change based on input data characterising agricultural activities and soil types.

#### 1.2. Skills developed
This project will combine spatial data, agricultural statistics and climate models with a steady-state soil C modelling approach. Key skill development will be:

* Understanding of steady-state soil carbon models
* Designing, scoping and executing modelling studies
* Model scenario testing and sensitivity testing
* Use of the R programming language
* Manipulation and harmonisation of spatial data
* Big data handling and analysis in the R environment

#### 1.3. Overview of project
You have been provided with an implementation of the IPCC (2019) steady-state soil C stock model for global croplands. This model is capable of estimating C stocks---and stock change over time---in soils under croplands. It has been parameterised such that it is possible to utilise this model to simulate---in theory---any cropland soil, anywhere in the world.

Your task will be to define and execute a series of cases studies using this model (in the order of 4--8, though the exact number is up to you) which examine the potential for C sequestration under Moroccan agricultural systems, and are as representative of Moroccan agriculture as a whole as possible.

To do this, you will need to:

1. Decide, based on available agricultural statistics and gridded data, which crops and agricultural areas should form the basis of your case studies.

2. Source, extract and format model input data for each of these case studies.

3. Run the model and analyse the results.

More detail on each of these separte elements is provided below in section 4.

**Note: You should treat everything provided in this project repository as a giant digital toolbox. By this I mean that the model app, all of the base data, and all of the helper functions provided are designed to equip you with a powerful jumping-off point from which to conduct your own analysis. It is up to you to decide how to use these materials and which questions you wish to answer. I will be on hand to help you make these decisions, but it is up to you to take the initiative and direct your own project.**

## 2. How does the model work?
The model is a simplified, steady-state, three-pool soil carbon model. By steady-state, it is meant that the model tries to deternine a soil C equilibrium, assuming consistency of year-on-year inputs. These three pools are differentiated primarily by different decay rates (i.e. rates at which soil carbon is lost, via microbial mineralisation, to the atmosphere as CO~2~). These pools are:

1. The active pool, which varies the most year on year, and has the highest rates of inputs and decay. It is fed by organic C inputs and by the slow and passive pools.

2. The slow pool, which varies less than the active pool and has lower decay rates. It is fed by the active pool and by organic C inputs.

3. The passive pool, which has the slowest rates of input and decay. It is fed by the active and slow pools only---it does not receive any direct organic C inputs.

The model simulates the flow of organic carbon into, out of and between these pools. The result can be used to estimate the net removal or addition of CO~2~ to or from the atmosphere. Environmental parameters for the model include monthly temperature, monthly precipitation, monthly potential evapotranspiration and soil sand fraction. Management related parameters include C inputs from crops, lignin and N content of organic matter, tillage practices and manure inputs. All of these things affect how quickly the pools gain and lose carbon, and how carbon flows between them.

The version of the model has been implemented using R, and is provided to you alongside an RShiny app which will allow you to use this model via a simple user interface.

## 3. Getting started
This project will involve using R and RStudio. For those of you who are less than confident in this environment, fear not---while you are not going to get away without at least looking at and modifying some code, **it is entirely possible to complete the project to a high standard with minimal or no writing of novel R code**. For those R enthusiasts amongst you, you will have complete and unrestricted access to all of the code with which this model is built and executed. If you ever wanted to get in amongst the workings of some relatively advanced R programming (like Shiny apps, functional programming, steady-state modelling and Monte Carlo simulation), this is your chance.

Regardless of where you are on the R enthusiasm scale, you need to make sure of the following before you start:

1. You have R version 3.6.2 or higher installed on your computer. You can check the version of R you are running by typing `R.version.string` into the console, and R will return the version for you. If you are not running v3.6.2 (or you don't have R installed at all), [this page](https://uvastatlab.github.io/phdplus/installR.html) provides install links for Windows and MacOS.

2. You have RStudio version 1.2.5033 or higher installed on your computer. You can check this by opening RStudio and going to 'About RStudio' on the top menu (the exact location varies depending on Mac/Windows layouts). If you don't have this version installed, you can find the install link for Mac and Windows [here](https://rstudio.com/products/rstudio/download/#download).

3. You have the `tidyverse` and `shiny` packages installed and up to date. This is crucial---the model won't run without this step! This simplest way to check this is to type `install.packages(c("tidyverse", "shiny"))` into the console and hit return. If you don't have them installed, this will install them; if you do, it'll update them as necessary.

**Note: I realise it's annoying to go through these steps before starting. It's good practice to update your R/RStudio versions regularly---it saves annoying errors and time wasted trying to figure out why. If you really want to skip the first two steps, you can, but if anything goes wrong when running the model, please come back to this stage and update everything as a first port of call. The last step (installing your packages) is not optional, and all you will get is pain and error messages if you skip this one!**

## 4. Launching and using the model UI
I will give everyone interested in this project a full walkthrough of how to use the model in the live introduction to this project. I will also make sure there is a video tutorial available in the Learn folder. As a quick reminder, here are the steps you need to go through to run the Shiny app version of the model:

1. Open RStudio.

2. In the top right-hand corner of RStudio, click the dropdown arrow next to where it says **Project: None** (note, if you already have an RStudio Project open, it'll say the name of that project instead of **Project: None**. Close it now if this is the case. If you don't know what an RStudio Project is, don't worry about it!).

3. Click **Open Project** and navigate to the folder where you've saved and extracted the project download folder. Double click on the **.RProj** file to open it (it'll be the only one in the folder that's not greyed out).

4. Click to the files tab in your bottom right-hand window, and click on the file entitled **app.R**.

5. When **app.R** opens in your main window, look for the green *Play* button on the top right of that window, with **Run App** written next to it. Click that button and the model UI will launch.

6. You are now ready to set up and run model scenarios using the data input tools provided. Refer to the video tutorial for a full walkthrough of this process.

## 5. Project tasks
If you've had a good look through the project folder, and followed along with the live project introduction, you should by now (hopefully) have quite a few ideas of things you might like to look into. The below is a quick overview of the different steps you should consider.

**Remember: You have a lot of data available to you in this folder (including everything you need to potentially run millions of different model scenarios), but you should not restrict yourself to this data for your decision making. You have the entire worldwide web at your disposal---if you have a question that can't easily be answered with this data, I expect you to look into the literature and data repositories to find the answer.**

### 5.1. Definition of study scope and selection of case studies
For this, your starting point is the R script **helper-scripts/model-data-creator.R**. The job of this script is to help you to a) visualise the helper data provided (all saved in the **helper-data/** folder) and b) extract from this raw data the input files required by the model.

If you run this script as is, it will extract and save the example data which is currently used in the model (saved in the **model-data/** folder). Your main task here is to understand how this script works, and modify it as necessary to create input files that represent the scenarios you want to analyse.

Think about:

1. Which crop(s) you want to look at. Which are produced most by Morocco? Are any increasing in area or yield? Which are most economically important?

2. What geographical areas do you wish to consider? Look at the crop production raster data, as well as information from the web, and decide on an area (or set of areas) that are representative.

3. What hypothetical scenarios do you want to think about? You are not constrained to modelling things which are strictly representative of current practice; the model simulation extends far into the future for this reason. How might you improve soil management in your chosen scenarios to maximise sequestration? How will you ensure this is realistic?

### 5.2. Set up and run model
Refer to Section 4 and the video materials to set up and execute your model runs. Note that you are not confined to the model UI---it's there to provide a comfortable environment in which to run the model, but this comes at the expense of efficiency and true control. If you're not afraid of a bit of coding, check out the R script **ipcc-model-setup.R** in the base directory. This script is used to create default scenario in the model UI, but you can modify it as you see fit if you want to run the model from the RStudio console.

### 5.3. Results analysis
The model UI gives you some visual and numeric outputs right away, and you should feel free to use these as much as you like. It also gives you the option to export your data to a .csv file, which you can use however you see fit to conduct your analysis. If you want true control over the this part of the project, you can do as suggested in 3.2 and run the model in the RStudio console using modifications of the R script **ipcc-model-setup.R**. This will give you the complete and unabridged model output to analyse as you see fit.

I expect you to define your own research questions, but if you need inspiration, you can think about answering questions like the following:

1. Where are areas/crops with the greatest potential for C sequestration?

2. Which crops/areas are most at risk of C loss?

3. What environmental policies would be most effective to increase soil C sequestration in Morocco, and what quantitative effect might these have?

4. What input factors are most important for determining soil C sequestration in these systems?

Like any scientific study, I expect you to clearly define your research questions at the start of your project, and design your analysis to answer them.

## 6. More things to think about
Below are some more ideas for additional areas you might like to look into as part of your projects:

1. Climate predictions are notoriously uncertain. You can see how this uncertainty is accounted for by looking at the final section of the **model-data-creator.R** script---the role of this part of the code is to generate the uncertainty in the climate data and save it into the file used by the model. At the moment it's highly arbitrary. Can you improve it? How about doing a climate-focused sensitivity analysis?

2. Crop yield and area predictions are also uncertain. Future crop yield and area has been simulated very simplistically for this model. Could you improve it? At the moment, every run of the model uses exactly the same predictions for these variables. Do you think this is useful? Could you change it?

3. The model doesn't include any data on costs. This is by design (it's a pure soil systems model, not an economic model), but the first question on the lips of any policymaker is often to do with cost. Can you source cost/benefit data to add to your scenarios and turn them into a fuller set of environmental management recommendations?

## 7. That's all folks
I hope this makes for an interesting project. Feel free to play with the model (and accompanying code) as much as you like, and experiment with its capabilities. My hope is that the materials provided here will provide you with a comprehensive support base for your project, and allow you to focus on the more compelling, dynamic elements of modelling. I will be on hand throughout the entire project to advise, problem-solve, help with coding and generally support you in your project development. Enjoy!
